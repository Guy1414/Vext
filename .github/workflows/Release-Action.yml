name: .NET Build and Release

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths-ignore:
      - '**.md'

jobs:
  build:
    runs-on: windows-latest
    continue-on-error: false 
    env:
      TESTRUNNER_PROJECT: './Vext.TestRunner/Vext.TestRunner.csproj'
      LSP_PROJECT: './Vext.LSP/Vext.LSP.csproj'
      EXTENSION_ROOT: './Vext VSCode Extension/Vext'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: './Vext VSCode Extension/Vext/package-lock.json'

    - name: Fail-Fast Project Check
      shell: pwsh
      run: |
        if (!(Test-Path ${{ env.TESTRUNNER_PROJECT }})) { throw "TestRunner project not found!" }
        if (!(Test-Path ${{ env.LSP_PROJECT }})) { throw "LSP project not found!" }

    - name: Prepare directories
      shell: pwsh
      run: |
        $null = New-Item -ItemType Directory -Force ./publish
        $null = New-Item -ItemType Directory -Force "${{ env.EXTENSION_ROOT }}/compiler"

    - name: Publish LSP
      run: |
        dotnet publish ${{ env.LSP_PROJECT }} `
          -c Release `
          -r win-x64  `
          -o "${{ env.EXTENSION_ROOT }}/compiler"

    - name: Package VS Code Extension
      shell: pwsh
      run: |
        cd "${{ env.EXTENSION_ROOT }}"
        npm ci
        # Fail-fast: Ensure npx succeeds before moving on
        npx @vscode/vsce package --out ../../publish/vext-extension.vsix || exit 1

    - name: Publish TestRunner
      run: |
        dotnet publish ${{ env.TESTRUNNER_PROJECT }} `
          -c Release -r win-x64 --self-contained true `
          -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true `
          -o ./publish

    - name: Calculate Semantic Version
      id: versioning
      shell: bash
      run: |
        # Fetch all tags to ensure we see everything
        git fetch --tags --force

        # Get the highest version tag across the whole repo
        # sort -V handles numeric ordering (so 10 > 2)
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n1)
        
        # If no tags exist, start at v0
        if [ -z "$LATEST_TAG" ]; then
          LATEST_TAG="v0"
        fi

        echo "Highest tag found: $LATEST_TAG"

        # Strip 'v' and handle the math
        CLEAN_TAG=${LATEST_TAG#v}

        if [[ $CLEAN_TAG =~ ^([0-9]+)$ ]]; then
            # Simple integer: v41 -> v42
            NEW_TAG="v$((CLEAN_TAG + 1))"
        elif [[ $CLEAN_TAG =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            # SemVer: v1.0.1 -> v1.0.2
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            NEW_TAG="v$MAJOR.$MINOR.$((PATCH + 1))"
        else
            # Fallback if the tag is something weird like "v-beta"
            NEW_TAG="v1"
        fi
        
        echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "name=Vext Build $NEW_TAG" >> $GITHUB_OUTPUT
        echo "New tag will be: $NEW_TAG"
        
    - name: Rename and Checksum
      shell: pwsh
      run: |
        $exePath = "./publish/Vext.TestRunner.exe"
        $vsixPath = "./publish/vext-extension.vsix"
        if (Test-Path $exePath && Test-Path $vsixPath) {
            Rename-Item "./publish/Vext.TestRunner.exe" -NewName "Vext-${{ steps.versioning.outputs.tag }}.exe"
            Rename-Item "./publish/vext-extension.vsix" -NewName "vext-extension-${{ steps.versioning.outputs.tag }}.vsix"
        } else {
            throw "File not found for renaming!"
        }
        
        Get-ChildItem "./publish" -Include *.exe, *.vsix -Recurse | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
            $hash | Out-File "$($_.FullName).sha256" -Encoding ascii
        }

    - name: Create Release Archives
      shell: pwsh
      run: |
        Compress-Archive -Path "./publish/*-${{ steps.versioning.outputs.tag }}.exe", `
                         "./publish/*-${{ steps.versioning.outputs.tag }}.vsix", `
                         "./publish/*.sha256" `
                         -DestinationPath "./publish/Vext-Artifacts-${{ steps.versioning.outputs.tag }}.zip" -Force
        
        git archive --format=zip HEAD -o ./publish/Vext-Full-Source-${{ steps.versioning.outputs.tag }}.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        tag_name: ${{ steps.versioning.outputs.tag }}
        name: ${{ steps.versioning.outputs.name }}
        files: |
          ./publish/*.exe
          ./publish/*.vsix
          ./publish/*.sha256
          ./publish/Vext-Artifacts-*.zip
          ./publish/Vext-Full-Source-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
