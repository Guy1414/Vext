name: .NET Build and Release

permissions:
  contents: write

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    env:
      TESTRUNNER_PROJECT: './Vext.TestRunner/Vext.TestRunner.csproj'
      LSP_PROJECT: './Vext.LSP/Vext.LSP.csproj'
      EXTENSION_ROOT: './Vext VSCode Extension/Vext'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: '${{ env.EXTENSION_ROOT }}/package-lock.json'

    # Create publish folder and compiler folder
    - name: Prepare directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force ./publish
        New-Item -ItemType Directory -Force "${{ env.EXTENSION_ROOT }}/compiler"

    # 1. Build the LSP and put it inside the Extension folder
    - name: Publish LSP for Extension
      shell: pwsh
      run: |
        dotnet publish ${{ env.LSP_PROJECT }} `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -o "${{ env.EXTENSION_ROOT }}/compiler"

    # 2. Package the VS Code Extension (once, after LSP exists)
    - name: Package VS Code Extension
      shell: pwsh
      run: |
        cd "${{ env.EXTENSION_ROOT }}"
        npm ci
        npx @vscode/vsce package --out ../../publish/vext-extension.vsix

    # 3. Build the standalone TestRunner (Vext.exe)
    - name: Publish TestRunner
      shell: pwsh
      run: |
        dotnet publish ${{ env.TESTRUNNER_PROJECT }} `
          -c Release -r win-x64 --self-contained true `
          -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true `
          -o ./publish

    - name: Rename TestRunner executable
      shell: pwsh
      run: Rename-Item "./publish/Vext.TestRunner.exe" -NewName "Vext.exe"

    # 4. Generate SHA256 checksums
    - name: Generate SHA256 checksums
      shell: pwsh
      run: |
        certutil -hashfile "./publish/Vext.exe" SHA256 | Select-Object -Skip 1 -First 1 | Out-File "./publish/Vext.exe.sha256" -Encoding ascii
        certutil -hashfile "./publish/vext-extension.vsix" SHA256 | Select-Object -Skip 1 -First 1 | Out-File "./publish/vext-extension.vsix.sha256" -Encoding ascii

    # 5. Zip the main artifacts
    - name: Zip publish folder
      shell: pwsh
      run: |
        Compress-Archive `
          -Path ./publish/Vext.exe,
                ./publish/Vext.exe.sha256,
                ./publish/vext-extension.vsix,
                ./publish/vext-extension.vsix.sha256 `
          -DestinationPath ./publish/Vext-v${{ github.run_number }}.zip `
          -Force

    # 6. Zip the source code
    - name: Zip source code
      shell: pwsh
      run: |
        git archive --format=zip HEAD -o ./publish/Source-Code-v${{ github.run_number }}.zip

    # 7. Create GitHub Release and upload assets
    - name: Create GitHub Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Vext Build v${{ github.run_number }}
        files: |
          ./publish/Vext.exe
          ./publish/Vext.exe.sha256
          ./publish/vext-extension.vsix
          ./publish/vext-extension.vsix.sha256
          ./publish/Vext-v${{ github.run_number }}.zip
          ./publish/Source-Code-v${{ github.run_number }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
