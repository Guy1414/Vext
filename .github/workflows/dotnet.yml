name: .NET Build and Release

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    env:
      TESTRUNNER_PROJECT: './Vext.TestRunner/Vext.TestRunner.csproj'
      LSP_PROJECT: './Vext.LSP/Vext.LSP.csproj'
      EXTENSION_ROOT: './Vext VSCode Extension/Vext'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Create Publish Directory
      run: mkdir publish

    - name: Ensure compiler directory exists
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force `
          "${{ env.EXTENSION_ROOT }}/Vext/compiler"

    # 1. Build the LSP and put it inside the Extension folder
    - name: Publish LSP for Extension
      run: |
        dotnet publish ${{ env.LSP_PROJECT }} `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -o "${{ env.EXTENSION_ROOT }}/Vext/compiler"

    # 2. Package the Extension into the publish folder
    - name: Package VS Code Extension
      shell: pwsh
      run: |
        cd "${{ env.EXTENSION_ROOT }}"
        npm install
        vsce package --out ../../publish/vext-extension.vsix

    # 3. Build the standalone TestRunner (Vext.exe)
    - name: Publish TestRunner
      run: |
        dotnet publish ${{ env.TESTRUNNER_PROJECT }} `
          -c Release -r win-x64 --self-contained true `
          -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true `
          -o ./publish

    - name: Rename TestRunner executable
      shell: pwsh
      run: Rename-Item "./publish/Vext.TestRunner.exe" -NewName "Vext.exe"

    # 4. Generate Checksums for BOTH the .exe and the .vsix
    - name: Generate SHA256 checksums
      shell: pwsh
      run: |
        certutil -hashfile "./publish/Vext.exe" SHA256 | Select-Object -Skip 1 -First 1 | Out-File "./publish/Vext.exe.sha256" -Encoding ascii
        certutil -hashfile "./publish/vext-extension.vsix" SHA256 | Select-Object -Skip 1 -First 1 | Out-File "./publish/vext-extension.vsix.sha256" -Encoding ascii

    # 5. Zip almost everything (This zip will now contain Vext.exe AND vext-extension.vsix)
    - name: Zip entire publish folder
      shell: pwsh
      run: |
        Compress-Archive `
          -Path ./publish/Vext.exe,
                ./publish/Vext.exe.sha256,
                ./publish/vext-extension.vsix,
                ./publish/vext-extension.vsix.sha256 `
          -DestinationPath ./publish/Vext-v${{ github.run_number }}.zip `
          -Force

      # 6. Zip everything
    - name: Zip entire publish folder
      shell: pwsh
      run: |
        Compress-Archive `
          -Path ./
          -DestinationPath ./publish/Source Code-v${{ github.run_number }}.zip `
          -Force

    # 6. Upload everything to the Release
    - name: Create GitHub Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Vext Build v${{ github.run_number }}
        files: |
          ./publish/Vext.exe
          ./publish/Vext.exe.sha256
          ./publish/vext-extension.vsix
          ./publish/vext-extension.vsix.sha256
          ./publish/Vext-v${{ github.run_number }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
